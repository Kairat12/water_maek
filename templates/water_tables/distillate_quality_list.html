{% extends "base.html" %}
{% load static %}
{% block content %}
    <title>{% block title %}Качество дистиллята глубокой очистки (ДГО) на входе химводоочистки (ХВО) ТЭЦ-1, ТЭЦ 2,
            ТЭС
            и обессоленной воды (ОВ) на выходе ХВО ТЭЦ-1, ТЭЦ 2, ТЭС{% endblock title%}</title>
    <div class="container table-margin">
        <h3 class="h3 mt-4 mb-2">Качество дистиллята глубокой очистки (ДГО) на входе химводоочистки (ХВО) ТЭЦ-1, ТЭЦ 2,
            ТЭС
            и обессоленной воды (ОВ) на выходе ХВО ТЭЦ-1, ТЭЦ 2, ТЭС

        </h3>
        <h4 class="h4">{{ distillate_qualities.date_added|date:"d.m.Y" }}</h4>
        {#     THIS IS TABLE VARIANT       #}
        {#        <table class="table table-bordered">#}
        {#            <thead>#}
        {#            <tr>#}
        {#                <th scope="col">Место отбора</th>#}
        {#                {% for distillate_quality_station in distillate_qualities.distillatequalitystation_set.all %}#}
        {#                    {% if forloop.first %}#}
        {#                        {% for fact_attributefact in distillate_quality_station.fact.factattributefact_set.all %}#}
        {#                            <th scope="col">{{ fact_attributefact.attribute.name }}</th>#}
        {#                        {% endfor %}#}
        {#                    {% endif %}#}
        {#                {% endfor %}#}
        {#            </tr>#}
        {#            </thead>#}
        {#            <tbody>#}
        {##}
        {#            {% for distillate_quality_station in distillate_qualities.distillatequalitystation_set.all %}#}
        {#                {% if distillate_quality_station.station.name == 'TEC1' %}#}
        {#                    <tr>#}
        {#                        <th scope="col" class="text-center"#}
        {#                            colspan="{{ distillate_quality_station.fact.factattributefact_set.all.count|add:1 }}">#}
        {#                            {{ distillate_quality_station.station }}#}
        {#                        </th>#}
        {#                    </tr>#}
        {#                    <tr>#}
        {#                        <td><b>нормы</b></td>#}
        {#                        <td></td>#}
        {#                        {% if distillate_quality_station.fact.name == 'ДГО вход ХВО' %}#}
        {#                            <td><b>≤ 45</b></td>#}
        {#                            <td><b>6,5÷8,0</b></td>#}
        {#                            <td><b>≤ 30</b></td>#}
        {#                            <td><b>≤ 10</b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 30 </b></td>#}
        {#                            <td><b>≤ 100 </b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                        {% elif distillate_quality_station.fact.name == 'ОВ выход ХВО' %}#}
        {#                            <td>не нормируется</td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 1</b></td>#}
        {#                            <td><b>≤ 1</b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 4</b></td>#}
        {#                            <td><b>≤ 15</b></td>#}
        {#                            <td><b>≤ 30</b></td>#}
        {#                        {% endif %}#}
        {#                    </tr>#}
        {#                    <tr>#}
        {#                        <td><b>факт</b> {{ distillate_quality_station.fact.name }}</td>#}
        {#                        {% for fact_attributefact in distillate_quality_station.fact.factattributefact_set.all %}#}
        {#                            {% if fact_attributefact.not_count is True %}#}
        {#                                <td>не измеряется</td>#}
        {#                            {% else %}#}
        {#                                <td>{{ fact_attributefact.value }}</td>#}
        {#                            {% endif %}#}
        {#                        {% endfor %}#}
        {#                    </tr>#}
        {##}
        {#                {% elif distillate_quality_station.station.name == 'TEC2' %}#}
        {#                    <tr>#}
        {#                        <th scope="col" class="text-center"#}
        {#                            colspan="{{ distillate_quality_station.fact.factattributefact_set.all.count|add:1 }}">#}
        {#                            {{ distillate_quality_station.station }}#}
        {#                        </th>#}
        {#                    </tr>#}
        {#                    <tr>#}
        {#                        <td><b>нормы</b></td>#}
        {#                        <td></td>#}
        {#                        {% if distillate_quality_station.fact.name == 'ДГО вход ХВО-2' %}#}
        {#                            <td><b>≤ 45</b></td>#}
        {#                            <td><b>6,5÷8,0</b></td>#}
        {#                            <td><b>≤ 30</b></td>#}
        {#                            <td><b>≤ 10</b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 30 </b></td>#}
        {#                            <td><b>≤ 100 </b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                        {% elif distillate_quality_station.fact.name == 'ОВ выход ХВО-2' %}#}
        {#                            <td>не нормируется</td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 1</b></td>#}
        {#                            <td><b>≤ 1</b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 4</b></td>#}
        {#                            <td><b>≤ 15</b></td>#}
        {#                            <td><b>≤ 30</b></td>#}
        {#                        {% endif %}#}
        {#                    </tr>#}
        {#                    <tr>#}
        {#                        <td><b>факт</b> {{ distillate_quality_station.fact.name }}</td>#}
        {#                        {% for fact_attributefact in distillate_quality_station.fact.factattributefact_set.all %}#}
        {#                            {% if fact_attributefact.not_count is True %}#}
        {#                                <td>не измеряется</td>#}
        {#                            {% else %}#}
        {#                                <td>{{ fact_attributefact.value }}</td>#}
        {#                            {% endif %}#}
        {#                        {% endfor %}#}
        {#                    </tr>#}
        {#                {% elif distillate_quality_station.station.name == 'TES' %}#}
        {#                    <tr>#}
        {#                        <th scope="col" class="text-center"#}
        {#                            colspan="{{ distillate_quality_station.fact.factattributefact_set.all.count|add:1 }}">#}
        {#                            {{ distillate_quality_station.station }}#}
        {#                        </th>#}
        {#                    </tr>#}
        {#                    <tr>#}
        {#                        <td><b>нормы</b></td>#}
        {#                        <td></td>#}
        {#                        {% if distillate_quality_station.fact.name == 'ДГО вход ХВО-3' %}#}
        {#                            <td><b>≤ 45</b></td>#}
        {#                            <td><b>6,5÷8,0</b></td>#}
        {#                            <td><b>≤ 30</b></td>#}
        {#                            <td><b>≤ 10</b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 30 </b></td>#}
        {#                            <td><b>≤ 100 </b></td>#}
        {#                            <td>не нормируется</td>#}
        {#                        {% elif distillate_quality_station.fact.name == 'ОВ выход ХВО-3' %}#}
        {#                            <td>не нормируется</td>#}
        {#                            <td>не нормируется</td>#}
        {#                            <td><b>≤ 1</b></td>#}
        {#                            <td><b>≤ 1</b></td>#}
        {#                            <td><b>≤ 50</b></td>#}
        {#                            <td><b>≤ 5</b></td>#}
        {#                            <td><b>≤ 20</b></td>#}
        {#                            <td><b>≤ 30</b></td>#}
        {#                        {% endif %}#}
        {#                    </tr>#}
        {#                    <tr>#}
        {#                        <td><b>факт</b> {{ distillate_quality_station.fact.name }}</td>#}
        {#                        {% for fact_attributefact in distillate_quality_station.fact.factattributefact_set.all %}#}
        {#                            {% if fact_attributefact.not_count is True %}#}
        {#                                <td>не измеряется</td>#}
        {#                            {% else %}#}
        {#                                <td>{{ fact_attributefact.value }}</td>#}
        {#                            {% endif %}#}
        {#                        {% endfor %}#}
        {#                    </tr>#}
        {#                {% endif %}#}
        {##}
        {#            {% endfor %}#}
        {##}
        {#            </tbody>#}
        {#        </table>#}
        {#     THIS IS TABLE VARIANT       #}

        {#     THIS IS BLOCK VARIANT       #}
        <div class="mt-5 mb-5">
            <div>
                <div class="d-flex">
                    {% for distillate_quality_station in distillate_qualities.distillatequalitystation_set.all %}
                        {% if forloop.first %}
                            <div class="border p-1 w-10 fw-bold">Место отбора</div>
                            {% for fact_attributefact in distillate_quality_station.fact.factattributefact_set.all|dictsort:"id" %}
                                <div class="border p-1 w-10 fw-bold">{{ fact_attributefact.attribute.name }}</div>
                            {% endfor %}
                            {% if distillate_quality_station.station in request.user.profile.stations.all or request.user.is_superuser %}
                                <div class="border p-1 w-10 fw-bold">Действие</div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
                {% for distillate_quality_station in distillate_qualities.distillatequalitystation_set.all %}
                    <div class="border pt-1 pb-1 text-center" style="width: calc(100% - 1px)">
                        <b>{{ distillate_quality_station.station }}</b></div>
                    <div class="d-flex fact_normal" id="fact_normal">
                        <div class="border p-1 w-10"><b>нормы</b></div>
                        <div class="border p-1 w-10 normal_value" data-value="not"></div>
                        {% if distillate_quality_station.fact.name == 'ДГО вход ХВО' %}
                            <div class="border p-1 w-10 normal_value" data-value="45"><b>≤ 45</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="6.5-8.0"><b>6,5÷8,0</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="10"><b>≤ 10</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30 </b></div>
                            <div class="border p-1 w-10 normal_value" data-value="100"><b>≤ 100 </b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                        {% elif distillate_quality_station.fact.name == 'ОВ выход ХВО' %}
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="1"><b>≤ 1</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="1"><b>≤ 1</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="4"><b>≤ 4</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="15"><b>≤ 15</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30</b></div>
                        {% elif distillate_quality_station.fact.name == 'ДГО вход ХВО-2' %}
                            <div class="border p-1 w-10 normal_value" data-value="45"><b>≤ 45</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="6.5-8.0"><b>6,5÷8,0</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="10"><b>≤ 10</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30 </b></div>
                            <div class="border p-1 w-10 normal_value" data-value="100"><b>≤ 100 </b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                        {% elif distillate_quality_station.fact.name == 'ОВ выход ХВО-2' %}
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="1"><b>≤ 1</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="1"><b>≤ 1</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="4"><b>≤ 4</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="15"><b>≤ 15</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30</b></div>
                        {% elif distillate_quality_station.fact.name == 'ДГО вход ХВО-3' %}
                            <div class="border p-1 w-10 normal_value" data-value="45"><b>≤ 45</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="6.5-8.0"><b>6,5÷8,0</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="10"><b>≤ 10</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30 </b></div>
                            <div class="border p-1 w-10 normal_value" data-value="100"><b>≤ 100 </b></div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                        {% elif distillate_quality_station.fact.name == 'ОВ выход ХВО-3' %}
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="not">не нормируется</div>
                            <div class="border p-1 w-10 normal_value" data-value="1"><b>≤ 1</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="1"><b>≤ 1</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="50"><b>≤ 50</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="5"><b>≤ 5</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="20"><b>≤ 20</b></div>
                            <div class="border p-1 w-10 normal_value" data-value="30"><b>≤ 30</b></div>
                        {% endif %}
                        {% if distillate_quality_station.station in request.user.profile.stations.all or request.user.is_superuser %}
                            <div class="border p-1 w-10 fw-bold"></div>
                        {% endif %}
                    </div>
                    <div class="d-flex fact_attributes" data-fact="{{ distillate_quality_station.fact.id }}">
                        <div class="border p-1 w-10"><b>факт</b> {{ distillate_quality_station.fact.name }}</div>
                        {% for fact_attributefact in distillate_quality_station.fact.factattributefact_set.all|dictsort:"id" %}
                            {% if fact_attributefact.not_count is True %}
                                <div class="border p-1 w-10 attribute">не измеряется</div>
                            {% else %}
                                <div class="border p-1 w-10 attribute " data-attribute="{{ fact_attributefact.id }}">
                                    <span class="non-edit">{{ fact_attributefact.value }}</span>
                                    <input type="number" style="display: none" step="0.1" class="editable w-100"
                                           value="{{ fact_attributefact.value|stringformat:".1f" }}"/>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% if distillate_quality_station.station in request.user.profile.stations.all or request.user.is_superuser %}
                            <div class="border p-1 w-10 fw-bold">
                                <div class="buttons">
                                    <a href="javascript:" id="edit-btn"
                                       class="nav-link edit-btn  edit-{{ distillate_quality_station.fact.id }}">Изменить</a>
                                    <a href="javascript:" id="save-btn" style="display: none"
                                       class="save-btn nav-link save-{{ distillate_quality_station.fact.id }}">Сохранить</a>
                                    <a href="javascript:" id="cancel-btn" style="display: none"
                                       class="cancel-btn nav-link cancel-{{ distillate_quality_station.fact.id }}">Отменить</a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {#     THIS IS BLOCK VARIANT       #}
    </div>
    <div class="modal fade " id="succesModal" tabindex="-1" role="dialog" aria-labelledby="succesModal"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="h5">Ваши данные успешно сохранены !</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="succesModalClose" data-dismiss="modal">Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="{% static 'journal/vendor/jquery/jquery-2.2.4.min.js' %}"></script>
    <script>
        let editBtns = document.querySelectorAll(".edit-btn");
        let saveBtns = document.querySelectorAll(".save-btn");
        let cancelBtns = document.querySelectorAll(".cancel-btn");

        editBtns.forEach((el) => {
            el.addEventListener("click", (e) => {
                let target = e.target;
                let factAttributes = target.closest(".fact_attributes");
                let btns = target.closest(".buttons");
                let saveBtn = btns.querySelector(".save-btn");
                let cancelBtn = btns.querySelector(".cancel-btn");
                target.style.display = "none";
                saveBtn.style.display = "block";
                cancelBtn.style.display = "block";
                let attributes = factAttributes.querySelectorAll(".attribute");
                attributes.forEach((el) => {
                    let nonEdit = el.querySelector(".non-edit");
                    let editAble = el.querySelector(".editable");
                    if (nonEdit && editAble){
                    nonEdit.style.display = "none";
                    editAble.style.display = "block";
                    }
                })
            })
        })
        cancelBtns.forEach((el) => {
            el.addEventListener("click", (e) => {
                let target = e.target;
                let btns = target.closest(".buttons")
                let editBtn = btns.querySelector(".edit-btn");
                let saveBtn = btns.querySelector(".save-btn");
                let factAttributes = target.closest(".fact_attributes");
                target.style.display = "none";
                saveBtn.style.display = "none";
                editBtn.style.display = "block";
                let attributes = factAttributes.querySelectorAll(".attribute");
                attributes.forEach((el) => {
                    let nonEdit = el.querySelector(".non-edit");
                    let editAble = el.querySelector(".editable");
                    if (nonEdit && editAble) {
                        editAble.style.display = "none";
                        nonEdit.style.display = "block";
                    }

                })
            })
        })
        saveBtns.forEach((el) => {
            el.addEventListener("click", (e) => {
                let target = e.target;
                let btns = target.closest(".buttons");
                let editBtn = btns.querySelector(".edit-btn");
                let saveBtn = btns.querySelector(".save-btn");
                let cancelBtn = btns.querySelector(".cancel-btn");
                let factAttributes = target.closest(".fact_attributes");
                let factAttributes_id = factAttributes.dataset.fact;
                let attributes = factAttributes.querySelectorAll(".attribute");
                let data = {}
                attributes.forEach((el) => {
                    let id = el.dataset.attribute;
                    if (id){
                    data[id] = el.querySelector(".editable").value;
                    }
                })

                fetch('{% url "water_tables:edit_fact" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')  // Добавьте CSRF-токен
                    },
                    body: JSON.stringify({
                        factAttributesId: factAttributes_id,
                        data: data,
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        $('#succesModal').modal('show');
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            });
        })

        function getCookie(name) {
            var value = "; " + document.cookie;
            var parts = value.split("; " + name + "=");
            if (parts.length == 2) return parts.pop().split(";").shift();
        }

        $("#succesModalClose").on("click", function () {
            $("#succesModal").modal("hide");
            location.reload();
        });
        

    </script>
{% endblock content %}